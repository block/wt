#!/usr/bin/env bash
#
# wt-completion â€” Shell completion for the unified `wt` command
# ==============================================================
#
# This file provides shell completion for the unified `wt` command defined
# in wt.sh. It is sourced by wt.sh and supports both zsh and bash.
#
# Note: This is for the `wt <subcommand>` syntax (e.g., `wt add`, `wt switch`).
# For completion of standalone `wt-*` scripts (e.g., `wt-add`, `wt-switch`),
# see the completion files in the completion/ directory.
#

# Completion support for zsh
if [[ -n "$ZSH_VERSION" ]]; then
  _wt_completion() {
    # Reload config to get current context settings
    wt_read_config "$HOME/.wt/current" 2>/dev/null || true
    local -a commands
    commands=(
      'add:Create a new worktree for a branch'
      'switch:Switch the active worktree symlink'
      'remove:Remove a worktree'
      'list:List all worktrees with status'
      'cd:Change directory to a worktree'
      'context:Switch repository context'
      'metadata-export:Export project metadata to vault'
      'metadata-import:Import project metadata into worktree'
      'ijwb-export:Export .ijwb metadata to vault (legacy alias)'
      'ijwb-import:Import .ijwb metadata into worktree (legacy alias)'
      'help:Show help message'
    )

    if (( CURRENT == 2 )); then
      _describe 'command' commands
    else
      case "${words[2]}" in
        add)
          # Complete branch names
          local branches
          branches=($(git branch -a 2>/dev/null | sed 's/^[* ]*//' | sed 's|remotes/origin/||'))
          _describe 'branch' branches
          ;;
        switch|remove|cd)
          # Complete worktree paths
          local worktrees
          if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
            worktrees=($(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-))
            _describe 'worktree' worktrees
          fi
          ;;
        context)
          # Complete context names and 'add' subcommand
          local repos_dir="$HOME/.wt/repos"
          local -a contexts subcommands
          subcommands=('add:Add a new repository context' '--list:List all contexts')
          if [[ -d "$repos_dir" ]]; then
            for conf in "$repos_dir"/*.conf(N); do
              [[ -f "$conf" ]] || continue
              local name="${conf:t:r}"
              contexts+=("$name")
            done
          fi
          _describe 'subcommand' subcommands
          if (( ${#contexts[@]} > 0 )); then
            _describe 'context' contexts
          fi
          ;;
        metadata-import|ijwb-import)
          # First arg: source directory or target worktree
          # Second arg: target worktree
          if (( CURRENT == 3 )); then
            # First argument - could be source or target, offer both directories and worktrees
            local worktrees
            if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
              worktrees=($(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-))
              _describe 'worktree' worktrees
            fi
            _files -/
          elif (( CURRENT == 4 )); then
            # Second argument - target worktree
            local worktrees
            if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
              worktrees=($(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-))
              _describe 'worktree' worktrees
            fi
          fi
          ;;
        metadata-export|ijwb-export)
          # Complete directories
          _files -/
          ;;
      esac
    fi
  }
  compdef _wt_completion wt
fi

# Completion support for bash
if [[ -n "$BASH_VERSION" ]]; then
  _wt_completion_bash() {
    # Reload config to get current context settings
    wt_read_config "$HOME/.wt/current" 2>/dev/null || true
    local cur commands
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    commands="add switch remove list cd context metadata-export metadata-import ijwb-export ijwb-import help"

    if [[ ${COMP_CWORD} -eq 1 ]]; then
      COMPREPLY=($(compgen -W "$commands" -- "$cur"))
    else
      case "${COMP_WORDS[1]}" in
        add)
          local branches
          branches=$(git branch -a 2>/dev/null | sed 's/^[* ]*//' | sed 's|remotes/origin/||')
          COMPREPLY=($(compgen -W "$branches" -- "$cur"))
          ;;
        switch|remove|cd)
          local worktrees
          if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
            worktrees=$(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-)
            COMPREPLY=($(compgen -W "$worktrees" -- "$cur"))
          fi
          ;;
        context)
          # Complete context names and 'add' subcommand
          local repos_dir="$HOME/.wt/repos"
          local contexts=""
          if [[ -d "$repos_dir" ]]; then
            for conf in "$repos_dir"/*.conf; do
              [[ -f "$conf" ]] || continue
              local name="${conf##*/}"
              name="${name%.conf}"
              contexts="$contexts $name"
            done
          fi
          COMPREPLY=($(compgen -W "add --list $contexts" -- "$cur"))
          ;;
        metadata-import|ijwb-import)
          # First arg: source directory or target worktree
          # Second arg: target worktree
          if [[ ${COMP_CWORD} -eq 2 ]]; then
            # First argument - could be source or target, offer both directories and worktrees
            local worktrees
            if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
              worktrees=$(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-)
              COMPREPLY=($(compgen -W "$worktrees" -- "$cur"))
            fi
            COMPREPLY+=($(compgen -d -- "$cur"))
          elif [[ ${COMP_CWORD} -eq 3 ]]; then
            # Second argument - target worktree
            local worktrees
            if [[ -n "$WT_MAIN_REPO_ROOT" ]] && [[ -d "$WT_MAIN_REPO_ROOT" ]]; then
              worktrees=$(git -C "$WT_MAIN_REPO_ROOT" worktree list --porcelain 2>/dev/null | grep '^worktree ' | cut -d' ' -f2-)
              COMPREPLY=($(compgen -W "$worktrees" -- "$cur"))
            fi
          fi
          ;;
        metadata-export|ijwb-export)
          # Complete directories
          COMPREPLY=($(compgen -d -- "$cur"))
          ;;
      esac
    fi
  }
  complete -F _wt_completion_bash wt
fi
