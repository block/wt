#!/usr/bin/env bash
#
# wt-context — Manage repository contexts for multi-repo support
# ==============================================================
#
# This command allows switching between multiple repository configurations.
# Each context represents a different git repository with its own worktree
# setup, metadata location, and default branch.
#
# Usage:
#   wt context              # Interactive: pick context from menu
#   wt context <name>       # Switch to named context
#   wt context --list       # List all contexts without switching
#   wt context add          # Add a new repository context
#   wt context add <path>   # Add context for repository at path
#   wt context add <name> <path>  # Add context with specific name
#
# Examples:
#   wt context              # Shows menu to pick from java, go, frontend
#   wt context java         # Switch to java context
#   wt context -l           # List all contexts
#   wt context add ~/code/myrepo  # Add new context (prompts for name)
#

set -euo pipefail

# Resolve script and lib directories
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# Bootstrap: source wt-common from lib/
if [[ -f "$LIB_DIR/wt-common" ]]; then
  . "$LIB_DIR/wt-common"
elif [[ -f "$HOME/.wt/lib/wt-common" ]]; then
  . "$HOME/.wt/lib/wt-common"
else
  echo "Error: Cannot find wt-common" >&2
  exit 1
fi

# Source wt-context library
wt_source wt-context

# Source wt-context-setup library for add command
wt_source wt-context-setup

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] [CONTEXT_NAME]
       $(basename "$0") add [NAME] [PATH]

Manage repository contexts for multi-repo support.

Options:
  -l, --list    List all contexts without switching
  -h, --help    Show this help message

Subcommands:
  add           Add a new repository context

Examples:
  $(basename "$0")              # Interactive selection
  $(basename "$0") java         # Switch to 'java' context
  $(basename "$0") --list       # List all contexts
  $(basename "$0") add          # Add new context (interactive)
  $(basename "$0") add ~/repo   # Add context for repository
  $(basename "$0") add myname ~/repo  # Add context with specific name
EOF
}

# ─────────────────────────────────────────────────────────────────────────────
# Add context subcommand - runs full setup flow
# ─────────────────────────────────────────────────────────────────────────────

add_context() {
  local repo_path=""
  local context_name=""

  # Parse add subcommand arguments
  case $# in
    0)
      # Interactive: wt_setup_context will prompt for both
      ;;
    1)
      # Just path provided
      repo_path="$1"
      ;;
    2)
      # Both name and path provided (name first for non-interactive use)
      context_name="$1"
      repo_path="$2"
      ;;
    *)
      error "Too many arguments for 'add' subcommand"
      usage
      exit 1
      ;;
  esac

  # Run the full setup flow from wt-context-setup library
  wt_setup_context "$repo_path" "$context_name"
}

# ─────────────────────────────────────────────────────────────────────────────
# List contexts
# ─────────────────────────────────────────────────────────────────────────────

list_contexts() {
  local repos_dir current_context
  repos_dir="$(wt_get_repos_dir)"
  current_context="$(wt_get_current_context)"

  if [[ ! -d "$repos_dir" ]] || ! compgen -G "$repos_dir/*.conf" >/dev/null 2>&1; then
    echo "No contexts configured."
    echo "Run 'wt context add' to add a repository."
    return 0
  fi

  echo

  for conf in "$repos_dir"/*.conf; do
    [[ -f "$conf" ]] || continue
    local name path prefix
    name="$(basename "$conf" .conf)"
    path="$(wt_get_context_repo_root "$name")"

    if [[ "$name" == "$current_context" ]]; then
      prefix="${GREEN}*${NC} "
    else
      prefix="  "
    fi

    printf "%s%-15s %s" "$prefix" "$name" "$path"
    if [[ "$name" == "$current_context" ]]; then
      printf " ${GREEN}(current)${NC}"
    fi
    echo
  done

  echo
}

# ─────────────────────────────────────────────────────────────────────────────
# Switch context
# ─────────────────────────────────────────────────────────────────────────────

switch_context() {
  local target_context="$1"

  if [[ -z "$target_context" ]]; then
    # Interactive selection
    target_context="$(select_context)" || exit 1
  fi

  if ! wt_context_exists "$target_context"; then
    error "Context not found: $target_context"
    echo "Available contexts:"
    wt_list_contexts | while read -r ctx; do
      echo "  $ctx"
    done
    exit 1
  fi

  wt_set_current_context "$target_context"
  success "Switched to: $target_context"
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

main() {
  local list_only=false
  local target_context=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -l|--list)
        list_only=true
        shift
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      add)
        shift
        add_context "$@"
        exit $?
        ;;
      -*)
        error "Unknown option: $1"
        usage
        exit 1
        ;;
      *)
        target_context="$1"
        shift
        ;;
    esac
  done

  if [[ "$list_only" == "true" ]]; then
    list_contexts
  else
    switch_context "$target_context"
  fi
}

main "$@"
